@{
    Layout = "_DashboardLayout";
    ViewData["Title"] = "Consumption";
    // optional consumer id provided by controller
    var consumerId = ViewBag.ConsumerId ?? "";
}
<div class="card p-4">
    <h4 class="mb-1">Consumption</h4>
    <p class="text-muted mb-3">View daily and monthly consumption for your meters.</p>

    <ul class="nav nav-tabs mb-3" id="consTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="daily-tab" data-bs-toggle="tab" data-bs-target="#daily" type="button" role="tab">Daily</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="monthly-tab" data-bs-toggle="tab" data-bs-target="#monthly" type="button" role="tab">Monthly</button>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="daily" role="tabpanel">
            <div class="row g-2 align-items-end mb-2">
                <div class="col-md-3">
                    <label class="form-label">Meter</label>
                    <input id="dailyMeter" class="form-control" placeholder="Meter serial (optional)" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">From</label>
                    <input id="dailyFrom" type="date" class="form-control" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">To</label>
                    <input id="dailyTo" type="date" class="form-control" />
                </div>
                <div class="col-md-3 text-end">
                    <button id="dailyLoad" class="btn btn-primary">Load</button>
                </div>
            </div>

            <div class="table-responsive">
                <table id="dailyTable" class="table table-hover">
                    <thead><tr><th>Meter</th><th>Date</th><th>kWh</th><th class="text-end">Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <nav aria-label="daily paging"><ul id="dailyPager" class="pagination justify-content-center"></ul></nav>
        </div>

        <div class="tab-pane fade" id="monthly" role="tabpanel">
            <div class="row g-2 align-items-end mb-2">
                <div class="col-md-3">
                    <label class="form-label">Meter</label>
                    <input id="monthlyMeter" class="form-control" placeholder="Meter serial (optional)" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">From (month)</label>
                    <input id="monthlyFrom" type="month" class="form-control" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">To (month)</label>
                    <input id="monthlyTo" type="month" class="form-control" />
                </div>
                <div class="col-md-3 text-end">
                    <button id="monthlyLoad" class="btn btn-primary">Load</button>
                </div>
            </div>

            <div class="table-responsive">
                <table id="monthlyTable" class="table table-hover">
                    <thead><tr><th>Meter</th><th>Month</th><th>kWh</th><th class="text-end">Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <nav aria-label="monthly paging"><ul id="monthlyPager" class="pagination justify-content-center"></ul></nav>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function(){
            const consumerId = '@consumerId';
            const pageSize = 10;

            // DAILY
            const dailyTable = document.querySelector('#dailyTable tbody');
            const dailyPager = document.getElementById('dailyPager');
            const dailyMeter = document.getElementById('dailyMeter');
            const dailyFrom = document.getElementById('dailyFrom');
            const dailyTo = document.getElementById('dailyTo');
            const dailyLoad = document.getElementById('dailyLoad');
            let dailyData = [], dailyPage = 1;

            // MONTHLY
            const monthlyTable = document.querySelector('#monthlyTable tbody');
            const monthlyPager = document.getElementById('monthlyPager');
            const monthlyMeter = document.getElementById('monthlyMeter');
            const monthlyFrom = document.getElementById('monthlyFrom');
            const monthlyTo = document.getElementById('monthlyTo');
            const monthlyLoad = document.getElementById('monthlyLoad');
            let monthlyData = [], monthlyPage = 1;

            function fmtDate(d){ if(!d) return ''; const dt=new Date(d); return dt.toLocaleDateString(); }
            function fmtMonth(d){ if(!d) return ''; const dt = new Date(d); return dt.toLocaleString(undefined, { year:'numeric', month:'short' }); }
            function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

            async function fetchDaily() {
                const q = [];
                if (consumerId) q.push(`consumerId=${encodeURIComponent(consumerId)}`);
                if (dailyMeter.value.trim()) q.push(`meterId=${encodeURIComponent(dailyMeter.value.trim())}`);
                if (dailyFrom.value) q.push(`from=${dailyFrom.value}`);
                if (dailyTo.value) q.push(`to=${dailyTo.value}`);
                const url = '/api/consumption/daily' + (q.length ? '?' + q.join('&') : '');
                try {
                    const resp = await fetch(url);
                    if (!resp.ok) { dailyData = []; showDailyError(await resp.text()); return; }
                    dailyData = await resp.json();
                    dailyPage = 1;
                    renderDaily();
                } catch (e) {
                    console.error(e);
                    dailyData = [];
                    showDailyError('Failed to load data.');
                }
            }

            async function fetchMonthly() {
                const q = [];
                if (consumerId) q.push(`consumerId=${encodeURIComponent(consumerId)}`);
                if (monthlyMeter.value.trim()) q.push(`meterId=${encodeURIComponent(monthlyMeter.value.trim())}`);
                if (monthlyFrom.value) q.push(`from=${monthlyFrom.value}`);
                if (monthlyTo.value) q.push(`to=${monthlyTo.value}`);
                const url = '/api/consumption/monthly' + (q.length ? '?' + q.join('&') : '');
                try {
                    const resp = await fetch(url);
                    if (!resp.ok) { monthlyData = []; showMonthlyError(await resp.text()); return; }
                    monthlyData = await resp.json();
                    monthlyPage = 1;
                    renderMonthly();
                } catch (e) {
                    console.error(e);
                    monthlyData = [];
                    showMonthlyError('Failed to load data.');
                }
            }

            function showDailyError(msg) {
                dailyTable.innerHTML = `<tr><td colspan="4" class="text-danger">Error: ${escapeHtml(msg)}</td></tr>`;
                dailyPager.innerHTML = '';
            }
            function showMonthlyError(msg) {
                monthlyTable.innerHTML = `<tr><td colspan="4" class="text-danger">Error: ${escapeHtml(msg)}</td></tr>`;
                monthlyPager.innerHTML = '';
            }

            function renderDaily() {
                dailyTable.innerHTML = '';
                if (!dailyData.length) {
                    dailyTable.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No daily consumption.</td></tr>';
                    dailyPager.innerHTML = ''; return;
                }
                const totalPages = Math.max(1, Math.ceil(dailyData.length / pageSize));
                if (dailyPage > totalPages) dailyPage = totalPages;
                const slice = dailyData.slice((dailyPage-1)*pageSize, dailyPage*pageSize);
                slice.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${escapeHtml(r.meterId||r.meterID||'')}</td>
                                    <td>${fmtDate(r.consumptionDate || r.date || r.day)}</td>
                                    <td>${Number(r.consumptionkWh||r.kwh||0).toFixed(2)}</td>
                                    <td class="text-end"><a class="btn btn-sm btn-outline-secondary" href="/Meter/Details?serial=${encodeURIComponent(r.meterId||r.meterID||'')}">Details</a></td>`;
                    dailyTable.appendChild(tr);
                });
                renderPager(dailyPager, dailyData.length, dailyPage, (p)=>{ dailyPage=p; renderDaily(); });
            }

            function renderMonthly() {
                monthlyTable.innerHTML = '';
                if (!monthlyData.length) {
                    monthlyTable.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No monthly consumption.</td></tr>';
                    monthlyPager.innerHTML = ''; return;
                }
                const totalPages = Math.max(1, Math.ceil(monthlyData.length / pageSize));
                if (monthlyPage > totalPages) monthlyPage = totalPages;
                const slice = monthlyData.slice((monthlyPage-1)*pageSize, monthlyPage*pageSize);
                slice.forEach(r => {
                    const tr = document.createElement('tr');
                    // month field may be MonthStartDate or monthStartDate or month
                    const monthVal = r.monthStartDate || r.monthStart || r.month;
                    tr.innerHTML = `<td>${escapeHtml(r.meterId||r.meterID||'')}</td>
                                    <td>${fmtMonth(monthVal)}</td>
                                    <td>${Number(r.monthlyConsumptionkWh||r.consumptionkWh||0).toFixed(2)}</td>
                                    <td class="text-end"><a class="btn btn-sm btn-outline-secondary" href="/Meter/Details?serial=${encodeURIComponent(r.meterId||r.meterID||'')}">Details</a></td>`;
                    monthlyTable.appendChild(tr);
                });
                renderPager(monthlyPager, monthlyData.length, monthlyPage, (p)=>{ monthlyPage=p; renderMonthly(); });
            }

            function renderPager(container, totalItems, currentPage, onPage) {
                container.innerHTML = '';
                const totalPages = Math.max(1, Math.ceil(totalItems / pageSize));
                function add(i, text, disabled, active) {
                    const li = document.createElement('li');
                    li.className = 'page-item ' + (active ? 'active' : '') + (disabled ? ' disabled' : '');
                    const a = document.createElement('a');
                    a.className = 'page-link';
                    a.href = '#';
                    a.textContent = text;
                    a.onclick = (e)=>{ e.preventDefault(); if(!disabled) onPage(i); };
                    li.appendChild(a);
                    container.appendChild(li);
                }
                add(Math.max(1,currentPage-1),'Previous', currentPage===1, false);
                for (let i=1;i<=totalPages;i++) add(i, i, false, i===currentPage);
                add(Math.min(totalPages,currentPage+1),'Next', currentPage===totalPages, false);
            }

            dailyLoad.addEventListener('click', fetchDaily);
            monthlyLoad.addEventListener('click', fetchMonthly);

            // load defaults (first time)
            fetchDaily();
            fetchMonthly();

        })();
    </script>
}
