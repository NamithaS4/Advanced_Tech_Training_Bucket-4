@{
    Layout = "_DashboardLayout";
    ViewData["Title"] = "Consumption";
    var consumerId = ViewBag.ConsumerId ?? "";
}
<div class="card p-4">
    <h4 class="mb-1">Consumption</h4>
    <p class="text-muted mb-3">View daily and monthly consumption for your meters.</p>

    <ul class="nav nav-tabs mb-3" id="consTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="daily-tab" data-bs-toggle="tab" data-bs-target="#daily" type="button" role="tab">Daily</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="monthly-tab" data-bs-toggle="tab" data-bs-target="#monthly" type="button" role="tab">Monthly</button>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="daily" role="tabpanel">
            <div class="row g-2 align-items-end mb-2">
                <div class="col-md-3">
                    <label class="form-label">Meter</label>
                    <input id="dailyMeter" class="form-control" placeholder="Meter serial" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">From</label>
                    <input id="dailyFrom" type="date" class="form-control" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">To</label>
                    <input id="dailyTo" type="date" class="form-control" />
                </div>
                <div class="col-md-3 text-end">
                    <button id="dailyLoad" class="btn btn-primary">Load</button>
                </div>
            </div>

            <div class="table-responsive">
                <table id="dailyTable" class="table table-hover">
                    <thead><tr><th>Meter</th><th>Date</th><th>kWh</th><th class="text-end">Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <nav aria-label="daily paging"><ul id="dailyPager" class="pagination justify-content-center"></ul></nav>
        </div>

        <div class="tab-pane fade" id="monthly" role="tabpanel">
            <div class="row g-2 align-items-end mb-2">
                <div class="col-md-3">
                    <label class="form-label">Meter</label>
                    <input id="monthlyMeter" class="form-control" placeholder="Meter serial (optional)" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">From (month)</label>
                    <input id="monthlyFrom" type="month" class="form-control" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">To (month)</label>
                    <input id="monthlyTo" type="month" class="form-control" />
                </div>
                <div class="col-md-3 text-end">
                    <button id="monthlyLoad" class="btn btn-primary">Load</button>
                </div>
            </div>

            <div class="table-responsive">
                <table id="monthlyTable" class="table table-hover">
                    <thead><tr><th>Meter</th><th>Month</th><th>kWh</th><th class="text-end">Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <nav aria-label="monthly paging"><ul id="monthlyPager" class="pagination justify-content-center"></ul></nav>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function(){
            const pageSize = 10;

            // MVC proxy endpoints (ConsumerController)
            const dailyBase = '@Url.Action("DailyJson", "Consumer")';
            const monthlyBase = '@Url.Action("MonthlyJson", "Consumer")';

            // DAILY
            const dailyTable = document.querySelector('#dailyTable tbody');
            const dailyPager = document.getElementById('dailyPager');
            const dailyMeter = document.getElementById('dailyMeter');
            const dailyFrom = document.getElementById('dailyFrom');
            const dailyTo = document.getElementById('dailyTo');
            const dailyLoad = document.getElementById('dailyLoad');
            let dailyData = [], dailyPage = 1;

            // MONTHLY
            const monthlyTable = document.querySelector('#monthlyTable tbody');
            const monthlyPager = document.getElementById('monthlyPager');
            const monthlyMeter = document.getElementById('monthlyMeter');
            const monthlyFrom = document.getElementById('monthlyFrom');
            const monthlyTo = document.getElementById('monthlyTo');
            const monthlyLoad = document.getElementById('monthlyLoad');
            let monthlyData = [], monthlyPage = 1;

            function fmtDate(d){ if(!d) return ''; const dt=new Date(d); return dt.toLocaleDateString(); }
            function fmtMonth(d){ if(!d) return ''; const dt = new Date(d); return dt.toLocaleString(undefined, { year:'numeric', month:'short' }); }
            function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

            // DAILY FETCH
            async function fetchDaily() {
                const q = [];
                if (dailyMeter.value.trim()) q.push(`meterId=${encodeURIComponent(dailyMeter.value.trim())}`);
                if (dailyFrom.value) q.push(`from=${dailyFrom.value}`);
                if (dailyTo.value) q.push(`to=${dailyTo.value}`);

                const url = dailyBase + (q.length ? '?' + q.join('&') : '');

                try {
                    const resp = await fetch(url, { credentials: 'same-origin' });
                    if (!resp.ok) {
                        const text = await resp.text();
                        dailyData = [];
                        showDailyError(text || `HTTP ${(resp.status)}`);
                        return;
                    }
                    dailyData = await resp.json();
                    dailyPage = 1;
                    renderDaily();
                } catch (e) {
                    dailyData = [];
                    showDailyError('Failed to load data.');
                }
            }

            // MONTHLY FETCH
            async function fetchMonthly() {
                const q = [];
                if (monthlyMeter.value.trim()) q.push(`meterId=${encodeURIComponent(monthlyMeter.value.trim())}`);
                if (monthlyFrom.value) q.push(`from=${monthlyFrom.value}`);
                if (monthlyTo.value) q.push(`to=${monthlyTo.value}`);

                const url = monthlyBase + (q.length ? '?' + q.join('&') : '');

                try {
                    const resp = await fetch(url, { credentials: 'same-origin' });
                    if (!resp.ok) {
                        const text = await resp.text();
                        monthlyData = [];
                        showMonthlyError(text || `HTTP ${(resp.status)}`);
                        return;
                    }
                    monthlyData = await resp.json();
                    monthlyPage = 1;
                    renderMonthly();
                } catch (e) {
                    monthlyData = [];
                    showMonthlyError('Failed to load data.');
                }
            }

            function showDailyError(msg) {
                dailyTable.innerHTML = `<tr><td colspan="4" class="text-danger">Error: ${escapeHtml(msg)}</td></tr>`;
                dailyPager.innerHTML = '';
            }
            function showMonthlyError(msg) {
                monthlyTable.innerHTML = `<tr><td colspan="4" class="text-danger">Error: ${escapeHtml(msg)}</td></tr>`;
                monthlyPager.innerHTML = '';
            }

            function renderDaily() {
                dailyTable.innerHTML = '';
                if (!dailyData.length) {
                    dailyTable.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No daily consumption.</td></tr>';
                    dailyPager.innerHTML = ''; return;
                }
                const slice = dailyData.slice((dailyPage-1)*pageSize, dailyPage*pageSize);

                slice.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${escapeHtml(r.meterId)}</td>
                        <td>${fmtDate(r.consumptionDate)}</td>
                        <td>${Number(r.consumptionkWh).toFixed(2)}</td>
                        <td class="text-end"><a class="btn btn-sm btn-outline-secondary" href="/Consumer/MeterDetails?serial=${encodeURIComponent(r.meterId)}">Details</a></td>`;
                    dailyTable.appendChild(tr);
                });

                renderPager(dailyPager, dailyData.length, dailyPage, (p)=>{ dailyPage=p; renderDaily(); });
            }

            function renderMonthly() {
                monthlyTable.innerHTML = '';
                if (!monthlyData.length) {
                    monthlyTable.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No monthly consumption.</td></tr>';
                    monthlyPager.innerHTML = ''; return;
                }
                const slice = monthlyData.slice((monthlyPage-1)*pageSize, monthlyPage*pageSize);

                slice.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${escapeHtml(r.meterId)}</td>
                        <td>${fmtMonth(r.monthStartDate)}</td>
                        <td>${Number(r.consumptionkWh).toFixed(2)}</td>
                        <td class="text-end"><a class="btn btn-sm btn-outline-secondary" href="/Consumer/MeterDetails?serial=${encodeURIComponent(r.meterId)}">Details</a></td>`;
                    monthlyTable.appendChild(tr);
                });

                renderPager(monthlyPager, monthlyData.length, monthlyPage, (p)=>{ monthlyPage=p; renderMonthly(); });
            }

            function renderPager(el, total, page, onPage){
                el.innerHTML = '';
                const totalPages = Math.max(1, Math.ceil(total / pageSize));
                function add(i, text, disabled, active){
                    const li = document.createElement('li');
                    li.className = 'page-item ' + (active?'active':'') + (disabled?' disabled':'');
                    const a = document.createElement('a');
                    a.className = 'page-link';
                    a.href = '#';
                    a.textContent = text;
                    a.onclick = e => { e.preventDefault(); if(!disabled) onPage(i); };
                    li.appendChild(a);
                    el.appendChild(li);
                }
                add(page-1, 'Previous', page===1, false);
                for(let i=1;i<=totalPages;i++) add(i, i, false, i===page);
                add(page+1, 'Next', page===totalPages, false);
            }

            dailyLoad.addEventListener('click', fetchDaily);
            monthlyLoad.addEventListener('click', fetchMonthly);

            fetchDaily();
            fetchMonthly();
        })();
    </script>
}
